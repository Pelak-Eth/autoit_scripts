#include <Excel.au3>
#include <IE.au3>
#include <File.au3>
#include <String.au3>
#include <Array.au3>
;#############################################
;Global Variables:    				    ##
;									        ##
Global $row = 4;SET STARTING ROW, Usually 4 ##
;#############################################
Global $sFilePath1 = @ScriptDir & "\Hudsonville Eligible PTNS.xlsx";"\Georgetown Eligible PTNS.xlsx" "\Eligible Business PTNS.xlsx" ;This file should already exist
Global $oExcel = _ExcelBookOpen($sFilePath1)
Global $oMyError = ObjEvent("AutoIt.Error","MyErrFunc")
;#######################
; Com Error Handler  ###
;#######################
Func MyErrFunc()
Local $HexNumber
Local $strMsg
$HexNumber = Hex($oMyError.Number, 8)
$strMsg  = "Error Number: " & $HexNumber & @CRLF
$strMsg &= "WinDescription: " & $oMyError.WinDescription & @CRLF
$strMsg &= "Script Line: " & $oMyError.ScriptLine & @CRLF
SetError(1)
Endfunc
;###################
;MAIN LOOP START  ##
;###################
While $row <= 674 ; SET ROW RANGE | GTOWN = 4 to 396, HTown = 4 to 674, BIZ 4 to 78 ###
;#################################################################################################
	For $col = 5 to 15 Step 1;
;#################################################################################################
		Local $CellValue = _ExcelReadCell($oExcel, $row, $col)
			If $CellValue == "" Then
				ExitLoop
			ElseIf StringLen($CellValue) > 10 Then
				Global $ptn = StringTrimLeft($CellValue, (StringLen($CellValue) - 10))
			Else
				Global $ptn = $CellValue
			EndIf
		Call("geteligible", $ptn, $row, $col)
	Next
		$row = ($row + 1)
		;MsgBox(0, "row =", $row, 3)
	WEnd
;~ ;########################################
;~ ;OLD LOOP Iterating down MUCH SLOWER!!!##
;~ ;########################################
;~ While $col < 20
;~ ;#################################################################################################
;~ 	For $row = 4 to 677 Step 1;SET ROW RANGE | GTOWN = 4 to 396, HTown = 4 to 677, BIZ 4 to 78 ###
;~ ;#################################################################################################
;~ 		Local $CellValue = _ExcelReadCell($oExcel, $row, $col)
;~ 			If StringLen($CellValue) > 10 Then
;~ 				Global $ptn = StringTrimLeft($CellValue, (StringLen($CellValue) - 10))
;~ 			Else
;~ 				Global $ptn = $CellValue
;~ 			EndIf
;~ 		Call("geteligible", $ptn, $row, $col)
;~ 	Next
;~ 		$col = ($col + 1)
;~ 		MsgBox(0, "col =", $col, 3)
;~ WEnd
;#############################################################################
;Function geteligible start													##
;Takes integers $ptn, $col, and $row										##
;Returns excel cell highlight if eligible, dark highlight if error occured  ##
;#############################################################################
Func geteligible($ptn, $row, $col)
$oIE = _IEAttach("Customer Main")
$oForm = _IEGetObjById($oIE, "enterPhoneNumberForm")
$oLogin = _IEFormElementGetObjByName($oForm, "mobilePhoneNumber")
_IEFormElementSetValue($oLogin, $ptn)
_IEFormSubmit($oForm)
Local $body = _IEBodyReadHTML($oIE)
If Not IsDeclared("$oExcel") Then
	_ExcelBookClose($oExcel, 1, 0)
	$oExcel = _ExcelBookOpen($sFilePath1)
EndIf
If StringInStr($body, "Not Eligibile") Then
	call("Elig_date", $ptn, $row, $col)
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFFFFFF; not Eligible, change to white
	_IEImgClick($oIE, "images/bt-done.gif", "src"); clicks done button, exists eligibility check
ElseIf StringInStr($body, "Code:") Then
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFFFF00
	_IEImgClick($oIE, "images/bt-done.gif", "src")
Elseif StringInStr($body, "not found") Then
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFF0000
	_IEImgClick($oIE, "images/bt-done.gif", "src")
Elseif StringInStr($body, "Incorrect length ") Then
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFF0000
	_IEImgClick($oIE, "images/bt-done.gif", "src")
Elseif StringInStr($body, "Phone number Mandatory field ") Then
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFFFFFF
	_IEImgClick($oIE, "images/bt-done.gif", "src")
Else
	MsgBox(0, "Searching for string messed up at row: ", $row, 1)
	$oExcel.Activesheet.cells($row, $col).Interior.Color = 0XFF0000
	_IEImgClick($oIE, "images/bt-done.gif", "src")
EndIf;
EndFunc
;###################################################
;Function Elig_date START						####
;Takes PTN, ROW, COL							####
;Writes Eligible Date with PTN to Excel Sheet   ####
;###################################################
Func Elig_date($ptn, $row, $col)
	local $elig_date[2]
	$oIEdate = _IEAttach("Upgrade Eligibility Details")
	$oTable = _IETableGetCollection($oIEdate, 4)
	$elig_arrays = _IETableWriteToArray($oTable, True)
	$elig_date_full = $elig_arrays[5][1]
	$elig_date = StringRegExpReplace($elig_date_full, "/01", "", 1)
	$ptn_and_date = ($elig_date&"-"&$ptn)
	_ExcelWriteCell($oExcel, $ptn_and_date, $row, $col)
EndFunc
