#include <Excel.au3>
#include <IE.au3>
#include <File.au3>
#include <String.au3>
#include <Array.au3>
;#####################################################################################################
;Global Variables  																				##
Global $sFilePath1 = @ScriptDir & "\Hudsonville Eligible PTNS.xlsx" ;This file should already exist ##
Global $oExcel = _ExcelBookOpen($sFilePath1)													;   ##
;#####################################################################################################
For $row = 455 to 676 Step 1; HUD: 4 to 676, GTOWN: 4 to 390
	Global $global_row = $row
	Local $lastname1 = _ExcelReadCell($oExcel, $row, 1)
	Local $strip_no = (StringLen($lastname1) - 4)
	Global $lastname = StringTrimRight($lastname1, $strip_no)
	Global $accno = _ExcelReadCell($oExcel, $row, 2)
	Call("open_acc_bypass", $lastname, $accno)
Next
	MsgBox(0, "Status: ", "FINISHED at " & $global_row, 5)
	Exit
;#############################################################################
;Function Start: get_ptns_from_acc											##
;Input: assumes account is open, see open_acc_bypass                        ##
;writes cleaned ptns, plan type, and if credit union member to excel sheet  ##
;#############################################################################
Func get_ptns_from_acc()
WinWait("Account Overview")
$oIE = _IEAttach("Account Overview")
_IELinkClickByIndex($oIE, 4)
WinWait("Account Details")
$oIEACC = _IEAttach("Account Details")
$oTable = _IETableGetCollection($oIEACC, 4)
$stuffarrays = _IETableWriteToArray($oTable, True)
Global $address = ($stuffarrays[2][0] & " " & $stuffarrays[3][0])
_ExcelWriteCell($oExcel, $address, $global_row, 13)
;########################
;Exit account overview ##
;########################
$oexit = _IEAttach("Account Details")
_IENavigate($oexit, "javascript:dialog('https://dara.sprint.com/uniquesig8a944deffe2308894cbf3a294ac50cab/uniquesig1/exitAccountInit.do?userAction=1','width=350,height=380,resizable=1',true)", 0)
Sleep(1000)
ControlSend("Sprint -- Webpage Dialog", "","[CLASSNN:Internet Explorer_Server1]", "{TAB}" & "{ENTER}")
Sleep(2000)
EndFunc
;###################################
;Function Start: open_acc_bypass  ##
;Input: $lastname, $acc,          ##
;Returns: opened account          ##
;###################################
Func open_acc_bypass($lastname1, $accno)
$oIE = _IEAttach("Customer Main"); Assumes Logged In
$oForm = _IEGetObjById($oIE, "customerLookupForm")
$oName = _IEFormElementGetObjByName($oForm, "lastname")
_IEFormElementSetValue($oName, $lastname1)
$oSelect = _IEFormElementGetObjByName($oForm, "option3")
_IEFormElementOptionselect($oSelect, "Account Number" , 1, "byText")
$oAcc = _IEFormElementGetObjByName($oForm, "option3Value")
_IEFormElementSetValue($oAcc, $accno)
_IEFormSubmit($oForm, 0)
Sleep(4000)
;#################################################################################################
;Handle Business accounts / No data found error / Customer already exist with same SSN error	##
;NO signInConfirmationForm for these error types												##
;TODO: properly access business accounts, MEH!!													##
;#################################################################################################
Local $errorbody = _IEBodyReadHTML($oIE)
If StringInStr($errorbody, "No data found") Then
	Return
ElseIf StringInStr($errorbody, "Account number not found") Then
	Return
ElseIf StringInStr($errorbody, "Customer already exist with the same SSN") Then
	Return
ElseIf StringInStr($errorbody, "The account is suspended") Then
	Return
ElseIf StringInStr($errorbody, "Incorrect length") Then
	Return
EndIf
;##############################
;bypass security dialog box  ##
;##############################
$oPopup = _IEAttach("Sign In Confirmation -- Webpage Dialog", "embedded")
If @error = $_IEStatus_NoMatch Then
	Sleep(1000)
	$oPopup = _IEAttach("Sign In Confirmation -- Webpage Dialog", "embedded")
Endif
_IELinkClickByIndex($oPopup, 1); clicks bypass link
Sleep(1000)
;#########################################################
;input ID and expiration date to bypass and submit form ##
;#########################################################
$oForm = _IEGetObjById($oPopup, "signInConfirmationForm")
$oID = _IEFormElementGetObjByName($oForm, "idNumber")
_IEFormElementSetValue($oID, "123123")
$oEXP = _IEFormElementGetObjByName($oForm, "idExpirationDate")
_IEFormElementSetValue($oEXP, "06/12/2016")
$oSelect = _IEFormElementGetObjByName($oForm, "idType")
_IEFormElementOptionselect($oSelect, "State ID #", 1, "bytext")
;_IEFormElementOptionselect($oForm, "US Driver License", 1, "bytext")
Sleep(500)
;##########################################################
;dirty ish method to click hidden OK javascript button  ###
;##########################################################
ControlSend("Sign In Confirmation -- Webpage Dialog", "","[CLASSNN:Internet Explorer_Server1]", "{TAB}" & "{TAB}" & "{TAB}" & "{TAB}" & "{TAB}" & "{TAB}" & "{ENTER}")
;####################
;Acc should be open #
;####################
Sleep(5000)
;############################################
;Handle lookup errors					   ##
;Errors occur after signInConfirmationForm ##
;############################################
If isObj($oIE) Then
	Local $body = _IEBodyReadHTML($oIE)
	If StringInStr($body, "The transaction may not be performed") Then; past due customer
	_ExcelWriteCell($oExcel, "PAST DUE!", $global_row, 4)
	Return
	ElseIf StringInStr($body, "Ban status") Then; non existent customer
	_ExcelWriteCell($oExcel, "CANCELLED ACC!", $global_row, 4)
	Return
	ElseIf StringInStr($body, "No data found") Then; business acc or other non existent error
	_ExcelWriteCell($oExcel, "BIZ or ERROR", $global_row, 4)
	Return
	ElseIf StringInStr($body, "Activation of subscribers") Then
	_ExcelWriteCell($oExcel, "2X Family Plan", $global_row, 4)
	Return
Else
	call("get_ptns_from_acc")
	EndIf
EndIf
EndFunc
